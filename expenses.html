<!doctype html>
<html>

<head>
    <title>Ausgaben</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html {
            font-family: sans-serif;
        }

        .modal {
            color: gray;
        }

        .align-right {
            text-align: right;
        }

        .float-right {
            float: right;
        }

        .display-none {
            display: none;
        }

        .error {
            border-color: red;
        }

        thead {
            font-weight: bold;
        }

        h1 {
            display: inline;
        }

        label {
            font-size: 70%;
            display: block;
        }

        .va-bottom {
            vertical-align: bottom;
        }

        tr>td .visible-on-tr-hover {
            visibility: hidden;
        }

        tr:hover>td .visible-on-tr-hover {
            visibility: visible;
        }
    </style>
    <script src="lib/uuidv4.min.js"></script>
    <script>
        "use strict";

        const state = {
            saved: true,
            edit: null,
            month: null,
            day: null,
            filename: null,
            data: {
                version: 2,
                expenses: []
            }
        }

        const dayHeadingFormat = new Intl.DateTimeFormat([], { weekday: 'long', day: '2-digit', month: '2-digit' });
        const dayFormat = new Intl.DateTimeFormat([], { day: '2-digit', month: '2-digit' });
        const monthFormat = new Intl.DateTimeFormat([], { month: 'long', year: 'numeric' });
        const decimalRegex = /^([0-9]+\.?[0-9]*|\.[0-9]+)$/;

        const today = dateToYmd(new Date(Date.now()));

        class ExpensesError {
            constructor(message, origins) {
                this.message = message;
                this.origins = origins;
            }
        }

        class Expense {
            constructor(dateString, amount, currency, exchangeRate, description) {
                if (arguments.length !== 1) {
                    // create new
                    this.id = uuidv4();
                    this.date = new Date(dateString);
                    this.amount = amount;
                    this.currency = currency;
                    this.exchangeRate = exchangeRate;
                    this.description = description;
                    this.createDate = new Date(Date.now());
                }
                else {
                    // create from json
                    const obj = arguments[0];
                    this.id = obj.id;
                    this.date = new Date(obj.date);
                    this.amount = obj.amount;
                    this.currency = obj.currency;
                    this.exchangeRate = obj.exchangeRate;
                    this.description = obj.description;
                    this.createDate = new Date(obj.createDate);
                }
            }

            getAmountChf() {
                if (isDefaultCurrency(this.currency)) {
                    return parseFloat(this.amount);
                }
                return parseFloat(this.exchangeRate) * parseFloat(this.amount);
            }
        }

        window.onerror = (msg, url, lineNo, columnNo, error) => {
            if (error instanceof ExpensesError) {
                error.origins.forEach(o => o.classList.add('error'))
                alert(error.message);
                return;
            }
            throw error;
        };

        window.addEventListener('beforeunload', e => {
            if (!state.saved) {
                e.preventDefault();
                e.returnValue = 'Ungespeicherte Änderungen vorhanden';
            }
        });

        document.onkeydown = e => {
            if (e.ctrlKey) {
                if (e.key === 'Enter') {
                    if (['description', 'amount', 'currency-input', 'exchange-rate'].includes(e.target.id)) {
                        if (state.edit) {
                            confirmLineEdit();
                        }
                        else {
                            submitExpense();
                        }
                        return false;
                    }
                }
                if (e.key === 'o') {
                    openFile();
                    return false;
                }
                if (e.key === 's') {
                    save();
                    return false;
                }
            }
            return true;
        };

        /*
         * Utility
         */
        function getMonth(ymd) {
            return ymd.substring(0, 7);
        }

        function dateToYmd(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, 0)}`;
        }

        function isSameDay(d1, d2) {
            return d1.getDate() === d2.getDate()
                && d1.getMonth() === d2.getMonth()
                && d1.getFullYear() === d2.getFullYear();
        }

        /*
         * Data store
         */
        function getExpenses() {
            return state.data.expenses;
        }

        function setExpenses(newExpenses) {
            state.data.expenses = newExpenses;
        }

        function getDaysOfMonth(month) {
            let days = {};
            let monthNumeric = parseInt(month.substring(5, 7)) - 1;
            let date = new Date(month);
            let dateOfToday = new Date(Date.now());
            while (date.getMonth() === monthNumeric) {
                let day = {
                    description: []
                };
                getExpenses()
                    .filter(e => isSameDay(date, e.date))
                    .forEach(e => {
                        day.amount = (day.amount || 0) + e.getAmountChf();
                        const firstHashPosition = e.description.indexOf('#');
                        const dealer = e.description.substr(0, firstHashPosition === -1 ? undefined : firstHashPosition).trim();
                        if (!day.description.includes(dealer)) {
                            day.description.push(dealer);
                        }
                    });
                days[dateToYmd(date)] = day;
                date.setDate(date.getDate() + 1);
            }
            return days;
        }

        function getExpensesOfDay(day) {
            return getExpenses()
                .filter(e => dateToYmd(e.date).substring(0, 10) === day);
        }

        /*
         * UI
         */
        function getAmountInput() {
            return document.getElementById('amount');
        }

        function getComputedChfValue() {
            return document.getElementById('computed-chf-value');
        }

        function getCurrencySelect() {
            return document.getElementById('currency-input');
        }

        function getDayExpensesDiv() {
            return document.getElementById('day-expenses');
        }

        function getDescriptionInput() {
            return document.getElementById('description');
        }

        function getExchangeRateInput() {
            return document.getElementById('exchange-rate');
        }

        function getSaveButton() {
            return document.getElementById('save-button');
        }

        function getFileInput() {
            return document.getElementById('file-input');
        }

        function getMonthTable() {
            return document.getElementById('month-table');
        }

        function getMonthLabel() {
            return document.getElementById('month-label');
        }

        function renderFloat(f) {
            return f.toFixed(2);
        }

        function renderDay(d) {
            return dayFormat.format(d);
        }

        function render() {
            let monthLabel = '';
            if (state.month) {
                monthLabel = monthFormat.format(new Date(state.month));
            }
            getMonthLabel().textContent = monthLabel;
            renderMonthTable();

            let dayHeading = '';
            if (state.day) {
                dayHeading = `<h2>${dayHeadingFormat.format(new Date(state.month + '-' + state.day))}</h2>`;
            }
            let dayTable = renderDayTable();
            getDayExpensesDiv().innerHTML = dayHeading + dayTable;

            getSaveButton().disabled = state.saved;

            getDescriptionInput().focus();
        }

        function renderMonthTable() {
            let tableContent = `
                    <thead>
                        <tr>
                            <td>Datum</td>
                            <td class="align-right">Betrag</td>
                            <td></td>
                            <td>Beschreibung</td>
                        </tr>
                    </thead>`;
            tableContent += '<tbody>';
            Object.entries(getDaysOfMonth(state.month))
                .forEach(d => {
                    const [ymd, row] = d;
                    tableContent += `
                    <tr>
                        <td><a href="#" onclick="setDay('${ymd.substring(8, 10)}');">${renderDay(new Date(ymd))}</a></td>
                        <td class="align-right">${row.amount ? renderFloat(row.amount) : ''}</td>
                        <td>${row.amount ? 'CHF' : ''}</td>
                        <td>${row.description.join(', ')}</td>
                    </tr>
                `;
                });
            tableContent += '</tbody>';
            getMonthTable().innerHTML = tableContent;
        }

        function renderForm(expense) {
            const currencies = ['CHF', '€'];
            let form = `
                <tr class="va-bottom">
                    <td>
                        <label for="description">Beschreibung</label>
                        <input id="description" value="${expense ? expense.description : ''}" required />
                    </td>
                    <td class="align-right">
                        <label for="amount">Betrag</label>
                        <input id="amount" class="align-right" oninput="handleAmountOrExchangeRateInput();" onchange="validateDecimalField(getAmountInput(), 2);" value="${expense ? expense.amount : ''}" required />
                    </td>
                    <td>
                        <label for="currency-input">Währung</label>
                        <select id="currency-input" onchange="handleCurrencyChanged()" required>
                            ${currencies.map(c => `<option value="${c}" ${c === expense?.currency ? 'selected' : ''}>${c}</option>`)}
                        </select>
                    </td>`;
            if (expense) {
                form += `
                    <td><button type="button" title="Speichern" onclick="confirmLineEdit();">✅</button></td>
                    <td><button type="button" title="Abbrechen" onclick="cancelLineEdit();">❌</button></td>`;
            }
            else {
                form += '<td><button type="button" title="Hinzufügen" onclick="submitExpense();">➕</button></td>';
            }
            const defaultCurrency = expense ? isDefaultCurrency(expense.currency) : true;
            form += `
                </tr>
                <tr id="form-line2" class="va-bottom ${defaultCurrency ? 'display-none' : ''}">
                    <td class="align-right">
                        <label for="exchange-rate">Wechselkurs</label>
                        <input class="align-right" id="exchange-rate" oninput="handleAmountOrExchangeRateInput();" onchange="validateDecimalField(getExchangeRateInput(), 5);" value="${expense ? expense.exchangeRate : 1}"/>
                    </td>
                    <td class="align-right">
                        <span id="computed-chf-value">${defaultCurrency ? '' : expense?.getAmountChf()}</span>
                    </td>
                    <td>CHF</td>
                </tr>`;
            return form;
        }

        function getLastExchangeRate(currency, date) {
            const expensesOfDay = getExpenses()
                .filter(e => e.currency && isSameDay(e.date, date));
            let relevantExpenses = expensesOfDay;

            if (expensesOfDay.length === 0) {
                const expensesOfCurrency = getExpenses()
                    .filter(e => e.currency === getCurrencySelect().value);

                if (expensesOfCurrency.length === 0) {
                    return null;
                }
                relevantExpenses = expensesOfCurrency;
            }

            return relevantExpenses
                .reduce((latest, e) => e.createDate > latest.createDate ? e : latest)
                .exchangeRate;
        }

        function handleCurrencyChanged() {
            if (isDefaultCurrency(getCurrencySelect().value)) {
                document.getElementById('form-line2').classList.add('display-none');
                getExchangeRateInput().value = 1;
            }
            else {
                document.getElementById('form-line2').classList.remove('display-none');
                const latestExchangeRate = getLastExchangeRate(getCurrencySelect().value, new Date(state.month + '-' + state.day));
                if (latestExchangeRate) {
                    getExchangeRateInput().value = latestExchangeRate;
                }
            }
        }

        function handleAmountOrExchangeRateInput() {
            if (isDefaultCurrency(getCurrencySelect().value)) {
                return;
            }
            const chfValue = parseFloat(getAmountInput().value) * parseFloat(getExchangeRateInput().value);
            getComputedChfValue().textContent = Number.isNaN(chfValue) ? '' : renderFloat(chfValue);
        }

        function isDefaultCurrency(currency) {
            return currency === 'CHF';
        }

        function renderDayTable() {
            let dayExpenses = getExpensesOfDay(state.month + '-' + state.day);
            let table = '<table>';
            if (dayExpenses.length > 0) {
                table += `
                        <thead>
                            <tr>
                                <td>Beschreibung</td>
                                <td class="align-right">Betrag</td>
                            </tr>
                        </thead>`;
            }
            table += '<tbody>';
            for (const expense of dayExpenses) {
                let row = '';
                if (state.edit === expense.id) {
                    row = renderForm(expense);
                }
                else {
                    row = `
                        <tr ${!state.edit ? '' : 'class="modal"'}>
                            <td>${expense.description}</td>
                            <td class="align-right">${renderFloat(expense.getAmountChf())}</td>
                            <td>CHF</td>
                            ${!state.edit ? `
                                <td><button type="button" title="Bearbeiten" class="visible-on-tr-hover" onclick="startLineEdit('${expense.id}')">🖊</button></td>
                                <td><button type="button" title="Löschen" class="visible-on-tr-hover" onclick="removeExpense('${expense.id}');">🚮</button></td>` : ''}
                        </tr>`
                }
                table += row;
            }
            if (!state.edit) {
                table += renderForm();
            }
            table += `
                    </tbody>
                </table>`;
            return table;
        }

        function validateDecimalField(decimalField, fractionalDigits) {
            decimalField.value = decimalField.value.trim();
            if (decimalField.dataset.validatedValue === decimalField.value) {
                return;
            }
            decimalField.classList.remove('error');
            if (!decimalField.value) {
                decimalField.dataset.validatedValue = decimalField.value;
                return;
            }
            if (!decimalRegex.test(decimalField.value)) {
                decimalField.dataset.validatedValue = decimalField.value;
                throw new ExpensesError(`'${decimalField.value}' ist keine gültige Zahl`, [decimalField]);
            }
            const components = decimalField.value.split('.');
            const integerPart = components[0] ? parseInt(components[0]) : '0';
            const fractionalPart = components[1] ? components[1].substring(0, fractionalDigits).padEnd(fractionalDigits, '0') : '00';
            decimalField.value = integerPart + '.' + fractionalPart;
            decimalField.dataset.validatedValue = decimalField.value;
        }

        function validateForm() {
            validateDecimalField(getAmountInput(), 2);
            validateDecimalField(getExchangeRateInput(), 5);

            const emptyFields = [];
            [getAmountInput(), getExchangeRateInput(), getDescriptionInput()].forEach(f => {
                f.classList.remove('error');
                if (!f.value) {
                    f.classList.add('error');
                    emptyFields.push(f);
                }
            });

            if (emptyFields.length > 0) {
                let fieldNames = emptyFields
                    .map(f => document.querySelector(`label[for="${f.id}"]`).textContent)
                    .join(' und ');
                throw new ExpensesError(`Bitte ${fieldNames} ausfüllen`, emptyFields);
            }
        }

        function removeExpense(id) {
            const index = getExpenses().findIndex(e => e.id === id);
            getExpenses().splice(index, 1);
            setSaved(false);
            render();
        }

        function startLineEdit(id) {
            state.edit = id;
            render();
        }

        function cancelLineEdit() {
            state.edit = null;
            render();
        }

        function confirmLineEdit() {
            storeForm(() => {
                const index = getExpenses().findIndex(e => e.id === state.edit);
                const entry = state.data.expenses[index];
                entry.amount = getAmountInput().value;
                entry.description = getDescriptionInput().value.trim();
                entry.currency = getCurrencySelect().value;
                entry.exchangeRate = getExchangeRateInput().value;
                state.edit = null;
            });
        }

        function submitExpense() {
            storeForm(() => getExpenses().push(new Expense(state.month + '-' + state.day, getAmountInput().value, getCurrencySelect().value, getExchangeRateInput().value, getDescriptionInput().value.trim())));
        }

        function storeForm(saveAction) {
            validateForm();

            saveAction();

            setSaved(false);
            render();
        }

        function setDay(day) {
            if (state.day === day) {
                return;
            }
            state.day = day;
            render();
        }

        function openFile() {
            if (!state.saved && !confirm('Beim Öffnen werden ungespeicherte Änderungen überschrieben. Bist du sicher dass du eine Datei öffnen möchtest?')) {
                return;
            }
            getFileInput().click();
        }

        function save() {
            let jsonString = JSON.stringify(state.data, null, 2);
            let dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonString);
            let a = document.createElement('a');
            a.rel = 'noopener';
            a.download = state.filename || 'ausgaben.json';
            a.target = '_blank';
            a.href = dataStr;
            a.dispatchEvent(new MouseEvent('click'));
            setSaved(true);
            render();
        }

        function setSaved(value) {
            if (getExpenses().length === 0) {
                state.saved = true;
                return;
            }
            state.saved = value;
        }

        function loadExpenses() {
            const file = getFileInput().files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                const migratedData = migrate(JSON.parse(e.target.result));
                setExpenses(migratedData.expenses
                    .map(e => new Expense(e)));
                render();
                state.filename = file.name;
            }
            reader.readAsText(file);
        }

        function migrate(loadedData) {
            if (!loadedData.expenses[0].currency) {
                let createDate = Date.now() - (loadedData.expenses.length) * 100;
                loadedData.expenses.forEach(e => {
                    e.currency = 'CHF';
                    e.exchangeRate = '1';
                    e.createDate = new Date(createDate).toJSON();
                    createDate = createDate + 100;
                });
                loadedData.version = 2;
                state.saved = false;
                return loadedData;
            }
            return loadedData;
        }
    </script>
</head>

<body>
    <h1>Ausgaben</h1>
    <span id="month-label"></span>
    <span class="float-right">
        <button type="button" title="Öffnen" onclick="openFile();">📂</button>
        <input type="file" id="file-input" class="display-none" onchange="loadExpenses()" />
        <button type="button" id="save-button" title="Speichern" onclick="save();">💾</button>
    </span>
    <hr>
    <table id="month-table"></table>
    <div id="day-expenses"></div>
    </table>

    <script>
        "use strict";
        state.month = today.substring(0, 7);
        state.day = today.substring(8, 10);
        render();
    </script>
</body>

</html>
