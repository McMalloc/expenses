<!doctype html>
<html>

<head>
    <title>Ausgaben</title>
    <meta charset="UTF-8">
    <style>
        .modal {
            color: gray;
        }

        .decimal-column {
            text-align: right;
        }

        thead {
            font-weight: bold;
        }
    </style>
    <script src="lib/uuidv4.min.js"></script>
    <script>
        "use strict";
        var state = {
            saved: true,
            edit: null,
            data: {
                version: 1,
                expenses: []
            }
        }

        var dateTimeFormat = new Intl.DateTimeFormat([], { day: '2-digit', month: '2-digit' });

        function getDateInput() {
            return document.getElementById('date');
        }

        function getAmountInput() {
            return document.getElementById('amount');
        }

        function getDescriptionInput() {
            return document.getElementById('description');
        }

        function getLineDateInput() {
            return document.getElementById('line-date');
        }

        function getLineAmountInput() {
            return document.getElementById('line-amount');
        }

        function getLineDescriptionInput() {
            return document.getElementById('line-description');
        }

        function getSaveButton() {
            return document.getElementById('save-button');
        }

        function getFileInput() {
            return document.getElementById('file-input');
        }

        function getMonthTable() {
            return document.getElementById('month-table');
        }

        function getExpenses() {
            return state.data.expenses;
        }

        function setExpenses(newExpenses) {
            state.data.expenses = newExpenses;
        }

        function dateToYmd(date) {
            return date.toISOString().substring(0, 10);
        }

        function renderFloat(f) {
            return f.toFixed(2);
        }

        function renderDate(d) {
            return dateTimeFormat.format(d);
        }

        function render() {
            renderMonthTable();
            renderDayTable();
        }

        function renderMonthTable() {
            let tableContent = '';
            if (getExpenses().length > 0) {
                tableContent += `
                    <thead>
                        <tr>
                            <td>Datum</td>
                            <td class="decimal-column">Betrag</td>
                            <td>Beschreibung</td>
                        </tr>
                    </thead>`;
            }
            tableContent += '<tbody>';
            let days = getExpenses().reduce((acc, e) => {
                let day = acc[dateToYmd(e.date)] || {};
                day.amount = (day.amount || 0) + parseFloat(e.amount);
                (day.description = day.description || []).push(e.description.substr(0, e.description.indexOf('#')).trim());
                acc[dateToYmd(e.date)] = day;
                return acc;
            }, {});
            Object.entries(days).forEach(d => {
                const [ymd, row] = d;
                tableContent += `
                    <tr>
                        <td>${renderDate(new Date(ymd))}</td>
                        <td class="decimal-column">${renderFloat(row.amount)}</td>
                        <td>${row.description.join(', ')}</td>
                    </tr>
                `;
            })
            tableContent += '</tbody>';
            getMonthTable().innerHTML = tableContent;
        }

        function renderDayTable() {
            var tableContent = '';
            if (getExpenses().length > 0) {
                tableContent += `
                    <thead>
                        <tr>
                            <td>Datum</td>
                            <td class="decimal-column">Betrag</td>
                            <td>Beschreibung</td>
                        </tr>
                    </thead>`;
            }
            tableContent += '<tbody>';
            for (const expense of getExpenses()) {
                let row = '';
                if (state.edit === expense.id) {
                    row = `
                    <tr>
                        <td><input id="line-date" type="date" value="${dateToYmd(expense.date)}"/></td>
                        <td><input id="line-amount" type="number" value="${expense.amount}"/> CHF</td>
                        <td><input id="line-description" value="${expense.description}"/></td>
                        <td><button onclick="confirmLineEdit();">‚úÖ</button></td>
                        <td><button onclick="cancelLineEdit();">‚ùå</button></td>
                    </tr>`;
                }
                else {
                    row = `
                    <tr ${!state.edit ? '' : 'class="modal"'}>
                        <td>${renderDate(expense.date)}</td>
                        <td class="decimal-column">${renderFloat(parseFloat(expense.amount))} CHF</td>
                        <td>${expense.description}</td>
                        ${!state.edit ? `
                            <td><button onclick="startLineEdit('${expense.id}')">üñä</button></td>
                            <td><button onclick="removeExpense('${expense.id}');">üöÆ</button></td>` : ''}
                    </tr>`
                }
                tableContent += row;
            }
            tableContent += '</tbody>';
            getSaveButton().disabled = state.saved;
            document.getElementById('expenses').innerHTML = tableContent;
        }

        function submitExpense() {
            var date = new Date(getDateInput().value);
            var amount = getAmountInput().value;
            var description = getDescriptionInput().value;

            if (date === '' || amount === '' || description === '') {
                alert('Bitte Datum, Betrag und Beschreibung ausf√ºllen');
                return;
            }

            getExpenses().push({
                id: uuidv4(),
                date: date,
                amount: amount,
                description: description
            });
            setSaved(false);
            getAmountInput().value = '';
            getDescriptionInput().value = '';
            render();
        }

        function removeExpense(id) {
            const index = getExpenses().findIndex(e => e.id === id);
            getExpenses().splice(index, 1);
            setSaved(false);
            render();
        }

        function startLineEdit(id) {
            state.edit = id;
            render();
        }

        function cancelLineEdit() {
            state.edit = null;
            render();
        }

        function confirmLineEdit() {
            const index = getExpenses().findIndex(e => e.id === state.edit);
            const entry = state.data.expenses[index];

            entry.date = new Date(getLineDateInput().value);
            entry.amount = getLineAmountInput().value;
            entry.description = getLineDescriptionInput().value;

            state.edit = null;
            setSaved(false);
            render();
        }

        function save() {
            let jsonString = JSON.stringify(state.data, null, 2);
            let dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonString);
            let a = document.createElement('a');
            a.rel = 'noopener';
            a.download = 'ausgaben.json';
            a.target = '_blank';
            a.href = dataStr;
            a.dispatchEvent(new MouseEvent('click'));
            setSaved(true);
            render();
        }

        function setSaved(value) {
            if (getExpenses().length === 0) {
                state.saved = true;
                return;
            }
            state.saved = value;
        }

        function loadExpenses() {
            var file = getFileInput().files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                let migratedData = migrate(JSON.parse(e.target.result));
                setExpenses(migratedData.expenses
                    .map(e => {
                        return {
                            id: e.id,
                            date: new Date(e.date),
                            amount: e.amount,
                            description: e.description
                        };
                    }));
                render();
            }
            reader.readAsText(file);
        }

        function migrate(loadedData) {
            setSaved(true);
            return loadedData;
        }
    </script>
</head>

<body>
    <h1>Ausgaben</h1>
    <hr>
    <input type="file" id="file-input" onchange="loadExpenses()" />
    <button id="save-button" onclick="save();">Speichern</button>
    <hr>
    <p>
        <label>Datum</label>
        <input id="date" type="date">
    </p>
    <p>
        <label>Betrag</label>
        <input id="amount" type="number">
        <label>CHF</label>
    </p>
    <p>
        <label>Beschreibung</label>
        <input id="description">
        <button onclick="submitExpense();">‚ûï</button>
    </p>
    <hr>
    <table id="month-table"></table>
    <table id="expenses" cellspacing="15">
    </table>

    <script>
        "use strict";
        getDateInput().value = dateToYmd(new Date(Date.now()));
        render();
    </script>
</body>

</html>
