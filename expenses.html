<!doctype html>
<html>

<head>
    <title>Ausgaben</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html {
            font-family: sans-serif;
        }

        h1 {
            display: inline;
        }

        .modal {
            color: gray;
        }

        .display-none {
            display: none;
        }

        .error {
            border-color: red;
        }

        .va-bottom {
            vertical-align: bottom;
        }

        tr>td .visible-on-tr-hover {
            visibility: hidden;
        }

        tr.modal:hover>td .visible-on-tr-hover {
            visibility: hidden;
        }

        tr:hover>td .visible-on-tr-hover {
            visibility: visible;
        }

        tr.heading {
            font-weight: bold;
        }

        tr.heading:not(:first-child) td {
            padding-top: 0.5em;
        }
    </style>
    <script src="lib/uuidv4.min.js"></script>
    <script>
        "use strict";

        const state = {
            saved: true,
            edit: null,
            month: null,
            monthDisplay: 'calendar',
            chartTags: [],
            day: null,
            filename: null,
            data: {
                version: 2,
                expenses: []
            }
        }

        const dayHeadingFormat = new Intl.DateTimeFormat([], { weekday: 'long', day: '2-digit', month: '2-digit' });
        const dayFormat = new Intl.DateTimeFormat([], { day: 'numeric' });
        const monthFormat = new Intl.DateTimeFormat([], { month: 'long', year: 'numeric' });
        const numberFormat = new Intl.NumberFormat(['de-CH'], { useGrouping: true, minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const decimalRegex = /^([0-9]+\.?[0-9]*|\.[0-9]+)$/;
        const integerRegex = /^([0-9]+)$/;
        const tagRegex = /#(\p{Letter}+)\b/ug;
        const defaultExchangeRate = '1.00000';

        const today = dateToYmd(new Date(Date.now()));

        class ExpensesError {
            constructor(message, origins) {
                this.message = message;
                this.origins = origins;
            }
        }

        class Expense {
            constructor() {
                this.setId(uuidv4());
                this.setCreateDate(new Date(Date.now()));
            }

            getId() {
                return this._id;
            }

            setId(id) {
                this._id = id;
            }

            getType() {
                return this._type;
            }

            setType(type) {
                this._type = type;
            }

            getDate() {
                return this._date;
            }

            setDate(date) {
                if (typeof date === 'string') {
                    this._date = new Date(date);
                    return;
                }
                this._date = date;
            }

            getAmount() {
                return this._amount;
            }

            setAmount(amount) {
                if (typeof amount !== 'string') {
                    throw 'Amount must be a string';
                }
                this._amount = amount;
            }

            getCurrency() {
                return this._currency;
            }

            setCurrency(currency) {
                this._currency = currency;
            }

            getExchangeRate() {
                return this._exchangeRate;
            }

            setExchangeRate(exchangeRate) {
                if (typeof exchangeRate !== 'string') {
                    throw 'Exchange rate must be a string';
                }
                this._exchangeRate = exchangeRate;
            }

            getDescription() {
                return this._description;
            }

            setDescription(description) {
                this._description = description.trim();
            }

            getCreateDate() {
                return this._createDate;
            }

            setCreateDate(createDate) {
                if (typeof createDate === 'string') {
                    this._createDate = new Date(createDate);
                    return;
                }
                this._createDate = createDate;
            }

            isRecurring() {
                return this._recurring;
            }

            setRecurring(recurring) {
                if (recurring) {
                    this.setDate(null);
                }
                else {
                    this.setRecurrencePeriodicity(null);
                    this.setRecurrenceFrequency(null);
                    this.setRecurrenceFrom(null);
                    this.setRecurrenceTo(null);
                }
                this._recurring = recurring;
            }

            getRecurrencePeriodicity() {
                return this._recurrencePeriodicity;
            }

            setRecurrencePeriodicity(recurrencePeriodicity) {
                this._recurrencePeriodicity = recurrencePeriodicity;
            }

            getRecurrenceFrequency() {
                return this._recurrenceFrequency;
            }

            setRecurrenceFrequency(recurrenceFrequency) {
                if (typeof recurrenceFrequency === 'string') {
                    this._recurrenceFrequency = parseInt(recurrenceFrequency);
                    return;
                }
                this._recurrenceFrequency = recurrenceFrequency;
            }

            getRecurrenceFrom() {
                return this._recurrenceFrom;
            }

            setRecurrenceFrom(recurrenceFrom) {
                if (typeof recurrenceFrom === 'string') {
                    this._recurrenceFrom = new Date(recurrenceFrom);
                    return;
                }
                this._recurrenceFrom = recurrenceFrom;
            }

            getRecurrenceTo() {
                return this._recurrenceTo;
            }

            setRecurrenceTo(recurrenceTo) {
                if (typeof recurrenceTo === 'string') {
                    this._recurrenceTo = new Date(recurrenceTo);
                    return;
                }
                this._recurrenceTo = recurrenceTo;
            }

            getTags() {
                let m = null;
                const tags = [];
                while (m = tagRegex.exec(this.getDescription())) {
                    tags.push(m[1]);
                }
                return tags;
            }

            computeAmountChf() {
                if (isDefaultCurrency(this.getCurrency())) {
                    return parseFloat(this.getAmount());
                }
                return parseFloat(this.getExchangeRate()) * parseFloat(this.getAmount());
            }

            computeMonthlyAmountChf() {
                return parseFloat(this.getExchangeRate()) * this.computeMonthlyAmount();
            }

            computeMonthlyAmount() {
                if (this.isRecurring()) {
                    let amountByFrequency = parseFloat(this.getAmount()) / this.getRecurrenceFrequency();
                    if (this.getRecurrencePeriodicity() === 'monthly') {
                        return amountByFrequency;
                    }
                    if (this.getRecurrencePeriodicity() === 'yearly') {
                        return amountByFrequency / 12;
                    }
                }
                return parseFloat(this.getAmount());
            }

            isValidOnDate(date) {
                if (this.isRecurring()) {
                    const firstDayOfNextMonth = getFirstDayOfNextMonth(date);
                    const firstDayOfCurrentMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                    return this.getRecurrenceFrom() < firstDayOfNextMonth && (!this.getRecurrenceTo() || this.getRecurrenceTo() >= firstDayOfCurrentMonth)
                }
                return isSameDay(date, this.getDate());
            }
        }

        window.onerror = (msg, url, lineNo, columnNo, error) => {
            if (error instanceof ExpensesError) {
                error.origins.forEach(o => o.classList.add('error'))
                alert(error.message);
                return;
            }
            throw error;
        };

        window.addEventListener('beforeunload', e => {
            if (!state.saved) {
                e.preventDefault();
                e.returnValue = 'Ungespeicherte Änderungen vorhanden';
            }
        });

        document.onkeydown = e => {
            if (e.key === 'Enter') {
                if (['description', 'amount', 'currency-input', 'date-input', 'exchange-rate', 'recurring-checkbox', 'recurring-frequency', 'recurring-monthly', 'recurring-yearly', 'recurring-from', 'recurring-to', 'type-select'].includes(e.target.id)) {
                    if (e.ctrlKey) {
                        submitForm();
                    }
                    // disable Enter-only for submitting
                    return false;
                }
            }
            if (e.ctrlKey) {
                if (e.key === 'o') {
                    openFile();
                    return false;
                }
                if (e.key === 's') {
                    save();
                    return false;
                }
            }
            return true;
        };

        /*
         * DateUtility
         */
        function getMonth(ymd) {
            return ymd.substring(0, 7);
        }

        function dateToYmd(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, 0)}`;
        }

        function isSameDay(d1, d2) {
            return d1.getDate() === d2.getDate()
                && d1.getMonth() === d2.getMonth()
                && d1.getFullYear() === d2.getFullYear();
        }

        function getFirstDayOfNextMonth(date) {
            if (date.getMonth() == 11) {
                return new Date(date.getFullYear() + 1, 0, 1);
            }
            return new Date(date.getFullYear(), date.getMonth() + 1, 1);
        }

        function isInMonth(date, month) {
            const firstDayOfNextMonth = getFirstDayOfNextMonth(month);
            const firstDayOfCurrentMonth = new Date(month.getFullYear(), month.getMonth(), 1);
            return date < firstDayOfNextMonth && date >= firstDayOfCurrentMonth;
        }

        /*
         * Data store
         */
        function getExpenses() {
            return state.data.expenses;
        }

        function getAllTags(filter) {
            const now = new Date(getCurrentDayString());
            return getExpenses()
                .filter(ex => ex.isRecurring() ? ex.isValidOnDate(now) : isInMonth(ex.getDate(), now))
                .filter(ex => ex.getType() === 'expense')
                .map(ex => ex.getTags())
                .reduce((allTags, tags) => {
                    tags.forEach(t => {
                        if (!allTags.includes(t)) {
                            allTags.push(t);
                        }
                    });
                    return allTags;
                }, []);
        }

        function setExpenses(newExpenses) {
            state.data.expenses = newExpenses;
        }

        function getCurrentDayString() {
            return state.month + '-' + state.day;
        }

        function getOnetimeExpenses() {
            return getExpenses()
                .filter(e => !e.isRecurring());
        }

        function getDaysOfMonth(month) {
            let days = {};
            let monthNumeric = parseInt(month.substring(5, 7)) - 1;
            let date = new Date(month);
            let dateOfToday = new Date(Date.now());

            // TODO refactor to use same code as month summary
            const income = getExpenses()
                .filter(e => e.getType() === 'income')
                .filter(e => e.isValidOnDate(new Date(getCurrentDayString())))
                .reduce((sum, e) => sum + e.computeAmountChf(), 0);

            const recurringExpenses = getExpenses()
                .filter(e => e.getType() === 'expense')
                .filter(e => e.isRecurring())
                .filter(e => e.isValidOnDate(new Date(getCurrentDayString())))
                .reduce((sum, e) => sum + e.computeAmountChf(), 0);

            const availableAmount = income - recurringExpenses;

            while (date.getMonth() === monthNumeric) {
                days[dateToYmd(date)] = getOnetimeExpenses()
                    .filter(e => e.getType() === 'expense' && e.isValidOnDate(date))
                    .reduce((day, e) => {
                        day.amount += e.computeAmountChf();
                        const firstHashPosition = e.getDescription().indexOf('#');
                        const dealer = e.getDescription().substr(0, firstHashPosition === -1 ? undefined : firstHashPosition).trim();
                        if (!day.description.includes(dealer)) {
                            day.description.push(dealer);
                        }
                        return day;
                    }, { amount: 0, description: [] });
                date.setDate(date.getDate() + 1);
            }

            const numDays = Object.entries(days).length;
            Object.entries(days)
                .filter(entry => new Date(entry[0]) < new Date(today))
                .forEach(entry => {
                    entry[1].saved = availableAmount / numDays - entry[1].amount
                });
            return days;
        }

        /*
         * UI
         */
        function getAmountInput() {
            return document.getElementById('amount');
        }

        function getComputedChfValue() {
            return document.getElementById('computed-chf-value');
        }

        function getCurrencySelect() {
            return document.getElementById('currency-input');
        }

        function getDateInput() {
            return document.getElementById('date-input');
        }

        function getDayExpensesDiv() {
            return document.getElementById('day-expenses');
        }

        function getDescriptionInput() {
            return document.getElementById('description');
        }

        function getExchangeRateInput() {
            return document.getElementById('exchange-rate');
        }

        function getExpenseForm() {
            return document.getElementById('expense-form');
        }

        function getSaveButton() {
            return document.getElementById('save-button');
        }

        function getFileInput() {
            return document.getElementById('file-input');
        }

        function getMainArea() {
            return document.getElementById('main-area');
        }

        function getMonthLabel() {
            return document.getElementById('month-label');
        }

        function getRecurringCheckbox() {
            return document.getElementById('recurring-checkbox');
        }

        function getRecurringExpenses() {
            return document.getElementById('recurring-expenses');
        }

        function getRecurringFrequency() {
            return document.getElementById('recurring-frequency');
        }

        function getRecurringFrom() {
            return document.getElementById('recurring-from');
        }

        function getRecurringFromToLabelSep() {
            return document.getElementById('recurring-fromto-label-sep');
        }

        function getRecurringFrequencySep() {
            return document.getElementById('recurring-frequency-sep');
        }

        function getRecurringMonthly() {
            return document.getElementById('recurring-monthly');
        }

        function getRecurringTo() {
            return document.getElementById('recurring-to');
        }

        function getRecurringYearly() {
            return document.getElementById('recurring-yearly');
        }

        function getTypeSelect() {
            return document.getElementById('type-select');
        }

        function renderFloat(f) {
            return numberFormat.format(f);
        }

        function renderDay(d) {
            return dayFormat.format(d);
        }

        function getEditExpense() {
            if (!state.edit) {
                return null;
            }
            const index = getExpenses().findIndex(e => e.getId() === state.edit);
            return state.data.expenses[index];
        }

        function renderAmountTd(content) {
            return `<td class="text-end">${content}</td>`;
        }

        function setMonthDisplay(monthDisplay) {
            if (monthDisplay === state.monthDisplay) {
                return;
            }
            state.monthDisplay = monthDisplay;
            render();
        }

        function renderMainArea() {
            const nav = `
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link ${state.monthDisplay === 'calendar' ? 'active' : ''}" onclick="setMonthDisplay('calendar');" href="#">Kalender</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link ${state.monthDisplay === 'chart' ? 'active' : ''}" onclick="setMonthDisplay('chart')" href="#">Diagramm</a>
                    </li>
                </ul>`;
            if (state.monthDisplay === 'calendar') {
                var content = renderMonthTable();
            }
            if (state.monthDisplay === 'chart') {
                var content = renderChart();
            }
            getMainArea().innerHTML = nav + content;
        }

        function renderChart() {
            const tags = getAllTags();
            return `
                <div>
                    ${tags.map(t => `<span class="badge ${state.chartTags.includes(t) ? 'bg-primary' : 'bg-secondary'}">${t}</span>`).join('\n')}
                </div>`;
        }

        function render() {
            let monthLabel = '';
            if (state.month) {
                monthLabel = monthFormat.format(new Date(state.month));
            }
            getMonthLabel().textContent = monthLabel;

            renderMonthOverview();
            renderMainArea();

            const dayTable = `
                <table class="table table-sm table-hover">
                    ${renderSection(dayHeadingFormat.format(new Date(getCurrentDayString())), e => e.getType() === 'expense' && !e.isRecurring(), false)}
                </table>`;
            const form = renderForm();
            getDayExpensesDiv().innerHTML = dayTable + form;

            refreshView();

            getSaveButton().disabled = state.saved;
            getDescriptionInput().focus();
            getExpenseForm().addEventListener('submit', submitForm);
        }

        function renderSection(heading, filter, sort) {
            const currentDay = new Date(getCurrentDayString());
            const expenses = getExpenses()
                .filter(filter)
                .filter(ex => ex.isValidOnDate(currentDay));

            if (sort) {
                expenses.sort((e1, e2) => e2.computeMonthlyAmountChf() - e1.computeMonthlyAmountChf());
            }

            const sum = expenses
                .reduce((sum, e) => sum + e.computeMonthlyAmountChf(), 0.0);

            const renderSum = sum > 0.005;

            let section = `
                        <tr class="heading">
                            <td>${heading}</td>
                            ${renderAmountTd(renderSum ? renderFloat(sum) : '')}
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>`;

            section += expenses
                .map(e => renderExpenseTr(`
                        <td>${e.getDescription()}</td>
                        ${renderAmountTd(renderFloat(e.computeMonthlyAmount()))}
                        <td>${isDefaultCurrency(e.getCurrency()) ? '' : e.getCurrency()}</td>
                        ${renderModificationButtons(e)}`))
                .join('\n');

            return section;
        }

        function renderMonthOverview() {
            let monthOverviewHtml = `
                <div class="bg-dark rounded p-2">
                    <table class="table table-dark table-sm table-hover">
                        ${renderSection('Einnahmen', e => e.getType() === 'income', true)}
                        ${renderSection('Wiederkehrende Ausgaben', e => e.getType() === 'expense' && e.isRecurring(), true)}
                        ${renderSection('Sparziele', e => e.getType() === 'goal', true)}
                    </table>
                </div>`;

            getRecurringExpenses().innerHTML = monthOverviewHtml;
        }

        function renderMonthTable() {
            let tableContent = '<table class="table table-sm table-hover">';
            Object.entries(getDaysOfMonth(state.month))
                .forEach(d => {
                    const [ymd, row] = d;
                    tableContent += `
                        <tr onclick="setDay('${ymd.substring(8, 10)}');">
                            <td class="text-end">${renderDay(new Date(ymd))}</td>
                            ${renderAmountTd(row.amount ? renderFloat(row.amount) : '')}
                            <td>${row.description.join(', ')}</td>
                            ${renderAmountTd(row.saved ? renderFloat(row.saved) : '')}
                        </tr>
            `;
                });
            return tableContent + '</table>';
        }

        function renderForm() {
            const expense = getEditExpense();
            const currencies = ['CHF', '€'];
            const defaultCurrency = expense ? isDefaultCurrency(expense.getCurrency()) : true;
            const expenseSelected = !expense || expense.getType() === 'expense';
            let form = `
                <form id="expense-form" autocomplete="off" novalidate>
                    <h2>${state.edit ? 'Bearbeiten' : 'Neu'}</h2>
                    <div class="form-floating mb-3">
                        <select id="type-select" class="form-select" placeholder="Typ" onchange="handleTypeChanged();">
                            <option value="expense" ${expenseSelected ? 'selected' : ''}>Ausgabe</option>
                            <option value="income" ${expense?.getType() === 'income' ? 'selected' : ''}>Einnahme</option>
                            <option value="goal" ${expense?.getType() === 'goal' ? 'selected' : ''}>Sparziel</option>
                        </select>
                        <label for="type-select">Typ</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input id="description" class="form-control" placeholder="Beschreibung" value="${expense ? expense.getDescription() : ''}" />
                        <label for="description">Beschreibung</label>
                    </div>
                    <div class="row g-2">
                        <div class="col-8 form-floating">
                            <input id="amount" class="form-control text-end" placeholder="Betrag" oninput="handleAmountOrExchangeRateInput();" onchange="validateDecimalField(getAmountInput(), 2);" value="${expense ? expense.getAmount() : ''}" />
                            <label for="amount">Betrag</label>
                        </div>
                        <div class="col-4 form-floating">
                            <select id="currency-input" class="form-select" onchange="handleCurrencyChanged()" required>
                                ${currencies.map(c => `<option value="${c}" ${c === expense?.getCurrency() ? 'selected' : ''}>${c}</option>`)}
                            </select>
                            <label for="currency-input">Währung</label>
                        </div>
                    </div>
                    <div id="form-line2" class="input-group mt-2">
                        <span class="input-group-text">Wechselkurs</span>
                        <input class="form-control text-end" id="exchange-rate" oninput="handleAmountOrExchangeRateInput();" onchange="validateDecimalField(getExchangeRateInput(), 5);" value="${expense ? expense.getExchangeRate() : defaultExchangeRate}" />
                        <span class="input-group-text">
                            <span id="computed-chf-value">${defaultCurrency ? '0.00' : renderFloat(expense?.computeAmountChf())}</span>
                            <span>&nbsp;CHF</span>
                        </span>
                    </div>
                    <div class="form-floating mt-3">
                        <input id="date-input" class="form-control" type="date" value="${expense?.getDate() ? dateToYmd(expense.getDate()) : (expense ? '' : getCurrentDayString())}" />
                        <label for="date-input">Datum</label>
                    </div>
                    <div class="form-check form-switch mt-4">
                        <input id="recurring-checkbox" class="form-check-input" type="checkbox" onchange="handleRecurringCheckboxChanged();" ${expense?.isRecurring() ? 'checked' : ''} />
                        <label for="recurring-checkbox" class="form-check-label">Wiederkehrend</label>
                    </div>
                    <div>
                        <input id="recurring-frequency" type="number" class="text-end" size="2" maxlength="2" value="${expense?.isRecurring() ? expense.getRecurrenceFrequency() : '1'}" onchange="validateIntegerField(getRecurringFrequency());" /><span id="recurring-frequency-sep">-</span>
                        <input id="recurring-monthly" name="recurring-periodicity" type="radio" ${!expense?.isRecurring() || expense.getRecurrencePeriodicity() === 'monthly' ? 'checked' : ''} /><label for="recurring-monthly">Monatlich</label>
                        <input id="recurring-yearly" name="recurring-periodicity" type="radio" ${expense?.getRecurrencePeriodicity() === 'yearly' ? 'checked' : ''} /><label for="recurring-yearly">Jährlich</label>
                    </div>`;
            const isRecurringToEnabled = expense?.isRecurring() || expense?.getType() === 'goal';
            form += `
                    <div id="recurring-fromto">
                        <label for="recurring-from">Start</label><label id="recurring-fromto-label-sep">/</label><label for="recurring-to">Ende</label>
                        <input id="recurring-from" type="date" value="${expense?.isRecurring() ? dateToYmd(expense.getRecurrenceFrom()) : ''}" />
                        <input id="recurring-to" type="date" value="${expense?.getRecurrenceTo() ? dateToYmd(expense.getRecurrenceTo()) : ''}" />
                    </div>
                    <div class="text-end">
                        ${expense ? `<button class="btn btn-secondary" type="button" title="Abbrechen" onclick="cancelLineEdit();">❌</button>` : ''}
                        <button class="btn btn-primary" type="submit" title="${expense ? 'Speichern' : 'Hinzufügen'}">${expense ? '✅' : '➕'}</button>
                    </div>
                </form>`;

            return form;
        }

        function getLastExchangeRate(currency, date) {
            // TODO Wechselkurse für wiederkehrende Ausgaben
            const expensesOfDay = getExpenses()
                .filter(e => e.getCurrency() && e.getDate() && isSameDay(e.getDate(), date));
            let relevantExpenses = expensesOfDay;

            if (expensesOfDay.length === 0) {
                const expensesOfCurrency = getExpenses()
                    .filter(e => e.getType() === 'expense' && e.getCurrency() === getCurrencySelect().value);

                if (expensesOfCurrency.length === 0) {
                    return null;
                }
                relevantExpenses = expensesOfCurrency;
            }

            return relevantExpenses
                .reduce((latest, e) => e.getCreateDate() > latest.getCreateDate() ? e : latest)
                .getExchangeRate();
        }

        function setVisible(field, visible) {
            const elements = [field];
            const label = document.querySelector(`label[for="${field.id}"]`);
            if (label) {
                elements.push(label);
            }
            if (visible) {
                elements.forEach(el => el.classList.remove('display-none'));
            }
            else {
                elements.forEach(el => el.classList.add('display-none'));
            }
        }

        function refreshView() {
            [getRecurringFrequency(),
            getRecurringMonthly(),
            getRecurringYearly(),
            getRecurringFrequencySep()]
                .forEach(f => setVisible(f, getRecurringCheckbox().checked));

            [getRecurringFrom(),
            getRecurringFromToLabelSep(),
            getRecurringTo()]
                .forEach(f => setVisible(f, getRecurringCheckbox().checked || getTypeSelect().value === 'goal'));

            setVisible(getRecurringCheckbox(), getTypeSelect().value !== 'goal');
            setVisible(getDateInput(), !getRecurringCheckbox().checked && getTypeSelect().value !== 'goal');
            setVisible(document.getElementById('form-line2'), !isDefaultCurrency(getCurrencySelect().value));

            getCurrencySelect().disabled = getTypeSelect().value === 'goal';
        }

        function handleTypeChanged() {
            if (getTypeSelect().value === 'goal') {
                getRecurringCheckbox().checked = false;
                getCurrencySelect().value = 'CHF';
                getExchangeRateInput().value = defaultExchangeRate;
            }
            refreshView();
        }

        function handleCurrencyChanged() {
            let exchangeRate = defaultExchangeRate;
            if (!isDefaultCurrency(getCurrencySelect().value)) {
                const referenceDate = new Date(getDateInput().value !== '' ? getDateInput().value : getCurrentDayString());
                exchangeRate = getLastExchangeRate(getCurrencySelect().value, referenceDate) || exchangeRate;
            }
            getExchangeRateInput().value = exchangeRate;

            refreshView();
        }

        function handleRecurringCheckboxChanged() {
            if (getRecurringCheckbox().checked) {
                getRecurringFrom().value = getDateInput().value;
                getDateInput().value = null;
            }
            else {
                getDateInput().value = getRecurringFrom().value;
                getRecurringFrom().value = null;
            }

            refreshView();
        }

        function handleAmountOrExchangeRateInput() {
            const chfValue = parseFloat(getAmountInput().value) * parseFloat(getExchangeRateInput().value);
            getComputedChfValue().textContent = Number.isNaN(chfValue) ? '' : renderFloat(chfValue);
        }

        function isDefaultCurrency(currency) {
            return currency === 'CHF';
        }

        function renderModificationButtons(expense) {
            return `
                    <td>
                        <button type="button" title="Bearbeiten" class="visible-on-tr-hover" onclick="startLineEdit('${expense.getId()}')">🖊</button>
                    </td>
                    <td>
                        <button type="button" title="Löschen" class="visible-on-tr-hover" onclick="removeExpense('${expense.getId()}');">🚮</button>
                    </td>`;
        }

        function renderExpenseTr(content) {
            return `<tr ${!state.edit ? '' : 'class="modal"'}>${content}</tr> `;
        }

        function validateDecimalField(decimalField, fractionalDigits) {
            validateField(decimalField, decimalRegex, () => {
                const components = decimalField.value.split('.');
                const integerPart = components[0] ? parseInt(components[0]) : '0';
                const fractionalPart = components[1] ? components[1].substring(0, fractionalDigits).padEnd(fractionalDigits, '0') : '00';
                return integerPart + '.' + fractionalPart;
            });
        }

        function validateIntegerField(integerField) {
            validateField(integerField, integerRegex, () => parseInt(integerField.value));
        }

        function validateField(field, regex, prettyPrinter) {
            field.value = field.value.trim();
            if (field.dataset.validatedValue === field.value) {
                return;
            }
            field.classList.remove('error');
            if (!field.value) {
                field.dataset.validatedValue = field.value;
                return;
            }
            if (!regex.test(field.value)) {
                field.dataset.validatedValue = field.value;
                throw new ExpensesError(`'${field.value}' ist keine gültige Zahl`, [field]);
            }
            const validatedValue = prettyPrinter();
            field.value = validatedValue;
            field.dataset.validatedValue = validatedValue;
        }

        function validateForm() {
            validateDecimalField(getAmountInput(), 2);
            validateDecimalField(getExchangeRateInput(), 5);
            validateIntegerField(getRecurringFrequency());

            const emptyFields = [];
            const mandatoryFields = [getAmountInput(), getExchangeRateInput(), getDescriptionInput()];
            if (getRecurringCheckbox().checked) {
                mandatoryFields.push(
                    getRecurringFrequency(),
                    getRecurringFrom());
            }
            else if (getTypeSelect().value === 'goal') {
                mandatoryFields.push(
                    getRecurringFrom(),
                    getRecurringTo());
            }
            else {
                mandatoryFields.push(getDateInput());
            }
            mandatoryFields.forEach(f => {
                f.classList.remove('error');
                if (!f.value) {
                    f.classList.add('error');
                    emptyFields.push(f);
                }
            });

            if (emptyFields.length > 0) {
                let fieldNames = emptyFields
                    .map(f => document.querySelector(`label[for="${f.id}"]`).textContent)
                    .join(' und ');
                throw new ExpensesError(`Bitte ${fieldNames} ausfüllen`, emptyFields);
            }
        }

        function removeExpense(id) {
            const index = getExpenses().findIndex(e => e.getId() === id);
            getExpenses().splice(index, 1);
            setSaved(false);
            render();
        }

        function startLineEdit(id) {
            state.edit = id;
            render();
        }

        function cancelLineEdit() {
            state.edit = null;
            render();
        }

        function getRecurrencePeriodicity() {
            if (!getRecurringCheckbox().checked) {
                return null;
            }
            if (getRecurringMonthly().checked) {
                return 'monthly';
            }
            if (getRecurringYearly().checked) {
                return 'yearly';
            }
        }

        function submitForm(event) {
            event?.preventDefault();

            validateForm();

            const expense = state.edit ? getEditExpense() : new Expense();
            if (getTypeSelect()) {
                expense.setType(getTypeSelect().value);
            }
            expense.setDate(getDateInput().value);
            expense.setAmount(getAmountInput().value);
            expense.setCurrency(getCurrencySelect().value);
            expense.setExchangeRate(getExchangeRateInput().value);
            expense.setDescription(getDescriptionInput().value);
            expense.setRecurrencePeriodicity(getRecurrencePeriodicity());
            expense.setRecurrenceFrequency(getRecurringFrequency().value);
            expense.setRecurrenceFrom(getRecurringFrom().value);
            if (getRecurringTo().value) {
                expense.setRecurrenceTo(getRecurringTo().value);
            }
            expense.setRecurring(getRecurringCheckbox().checked);

            if (state.edit) {
                state.edit = null;
            }
            else {
                getExpenses().push(expense);
            }

            setSaved(false);
            render();
        }

        function setDay(day) {
            if (state.day === day) {
                return;
            }
            state.day = day;
            render();
        }

        function openFile() {
            if (!state.saved && !confirm('Beim Öffnen werden ungespeicherte Änderungen überschrieben. Bist du sicher dass du eine Datei öffnen möchtest?')) {
                return;
            }
            getFileInput().click();
        }

        function save() {
            let jsonString = JSON.stringify(state.data, null, 2);
            let dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonString);
            let a = document.createElement('a');
            a.rel = 'noopener';
            a.download = state.filename || 'ausgaben.json';
            a.target = '_blank';
            a.href = dataStr;
            a.dispatchEvent(new MouseEvent('click'));
            setSaved(true);
            render();
        }

        function setSaved(value) {
            if (getExpenses().length === 0) {
                state.saved = true;
                return;
            }
            state.saved = value;
            if (!state.saved) {
                getFileInput().value = '';
            }
        }

        function loadExpenses() {
            const file = getFileInput().files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = evt => {
                const migratedData = migrate(JSON.parse(evt.target.result));
                setExpenses(migratedData.expenses
                    .map(obj => {
                        const expense = new Expense();
                        expense.setId(obj._id);
                        expense.setType(obj._type);
                        expense.setDate(obj._date);
                        expense.setAmount(obj._amount);
                        expense.setCurrency(obj._currency);
                        expense.setExchangeRate(obj._exchangeRate);
                        expense.setDescription(obj._description);
                        expense.setCreateDate(obj._createDate);
                        expense.setRecurring(obj._recurring);
                        expense.setRecurrencePeriodicity(obj._recurrencePeriodicity);
                        expense.setRecurrenceFrequency(obj._recurrenceFrequency);
                        expense.setRecurrenceFrom(obj._recurrenceFrom);
                        expense.setRecurrenceTo(obj._recurrenceTo);
                        return expense;
                    }));
                render();
                state.filename = file.name;
            }
            reader.readAsText(file);
        }

        function migrate(loadedData) {
            if (!loadedData.expenses[0]._id) {
                loadedData.expenses = loadedData.expenses.map(obj => {
                    return {
                        _id: obj.id,
                        _type: 'expense',
                        _date: obj.date,
                        _amount: obj.amount,
                        _currency: obj.currency,
                        _exchangeRate: obj.exchangeRate,
                        _description: obj.description,
                        _createDate: obj.createDate,
                        _recurring: obj.recurrence ? true : false,
                        _recurrencePeriodicity: obj.recurrence ? obj.recurrence.periodicity : null,
                        _recurrenceFrequency: obj.recurrence ? obj.recurrence.frequency : null,
                        _recurrenceFrom: obj.recurrence ? obj.recurrence.from : null,
                        _recurrenceTo: obj.recurrence ? obj.recurrence.to : null
                    };
                });
                state.saved = false;
            }
            return loadedData;
        }
    </script>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark px-3">
        <span id="month-label" class="navbar-brand">Ausgaben</span>
        <form class="d-flex">
            <button class="btn btn-light me-2" type="button" title="Öffnen" onclick="openFile();">📂</button>
            <input type="file" id="file-input" class="display-none" onchange="loadExpenses()" />
            <button class="btn btn-light" type="button" id="save-button" title="Speichern" onclick="save();">💾</button>
        </form>
    </nav>

    <div class="container-fluid my-4">
        <div class="row">
            <aside id="recurring-expenses" class="col col-3"></aside>
            <div id="main-area" class="col col-6"> </div>
            <div class="col col-3">
                <div id="day-expenses"></div>
            </div>
        </div>
    </div>

    <script>
        "use strict";
        state.month = today.substring(0, 7);
        state.day = today.substring(8, 10);
        render();
    </script>
</body>

</html>
