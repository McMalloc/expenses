<!doctype html>
<html>

<head>
    <title>Ausgaben</title>
    <meta charset="UTF-8">
    <style>
        html {
            font-family: sans-serif;
        }

        .modal {
            color: gray;
        }

        .align-right {
            text-align: right;
        }

        .float-right {
            float: right;
        }

        .display-none {
            display: none;
        }

        .error {
            border-color: red;
        }

        thead {
            font-weight: bold;
        }

        h1 {
            display: inline;
        }

        label {
            font-size: 70%;
        }

        .va-bottom {
            vertical-align: bottom;
        }

        tr>td .visible-on-tr-hover {
            visibility: hidden;
        }

        tr:hover>td .visible-on-tr-hover {
            visibility: visible;
        }
    </style>
    <script src="lib/uuidv4.min.js"></script>
    <script>
        "use strict";

        const state = {
            saved: true,
            edit: null,
            month: null,
            day: null,
            data: {
                version: 1,
                expenses: []
            }
        }

        const dayHeadingFormat = new Intl.DateTimeFormat([], { weekday: 'long', day: '2-digit', month: '2-digit' });
        const dayFormat = new Intl.DateTimeFormat([], { day: '2-digit', month: '2-digit' });
        const monthFormat = new Intl.DateTimeFormat([], { month: 'long', year: 'numeric' });
        const decimalRegex = /^([0-9]+\.?[0-9]*|\.[0-9]+)$/;

        const today = dateToYmd(new Date(Date.now()));

        class ExpensesError {
            constructor(message, origins) {
                this.message = message;
                this.origins = origins;
            }
        }

        window.onerror = (msg, url, lineNo, columnNo, error) => {
            if (error instanceof ExpensesError) {
                error.origins.forEach(o => o.classList.add('error'))
                alert(error.message);
                return;
            }
            throw error;
        };

        window.addEventListener('beforeunload', e => {
            if (!state.saved) {
                e.preventDefault();
                e.returnValue = 'Ungespeicherte Änderungen vorhanden';
            }
        });

        document.onkeydown = e => {
            if (e.ctrlKey) {
                if (e.key === 'Enter') {
                    if (['description', 'amount'].includes(e.target.id)) {
                        submitExpense();
                        return false;
                    }
                    if (['line-description', 'line-amount'].includes(e.target.id)) {
                        confirmLineEdit();
                        return false;
                    }
                }
                if (e.key === 'o') {
                    openFile();
                    return false;
                }
                if (e.key === 's') {
                    save();
                    return false;
                }
            }
            return true;
        };

        /*
         * Utility
         */
        function getMonth(ymd) {
            return ymd.substring(0, 7);
        }

        function dateToYmd(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, 0)}`;
        }

        function isSameDay(d1, d2) {
            return d1.getDate() === d2.getDate()
                && d1.getMonth() === d2.getMonth()
                && d1.getFullYear() === d2.getFullYear();
        }

        /*
         * Data store
         */
        function getExpenses() {
            return state.data.expenses;
        }

        function setExpenses(newExpenses) {
            state.data.expenses = newExpenses;
        }

        function getDaysOfMonth(month) {
            let days = {};
            let monthNumeric = parseInt(month.substring(5, 7)) - 1;
            let date = new Date(month);
            let dateOfToday = new Date(Date.now());
            while (date.getMonth() === monthNumeric) {
                let day = {
                    description: []
                };
                getExpenses()
                    .filter(e => isSameDay(date, e.date))
                    .forEach(e => {
                        day.amount = (day.amount || 0) + parseFloat(e.amount);
                        const firstHashPosition = e.description.indexOf('#');
                        day.description.push(e.description.substr(0, firstHashPosition === -1 ? undefined : firstHashPosition).trim());
                    });
                days[dateToYmd(date)] = day;
                if (isSameDay(dateOfToday, date)) {
                    break;
                }
                date.setDate(date.getDate() + 1);
            }
            return days;
        }

        function getExpensesOfDay(day) {
            return getExpenses()
                .filter(e => dateToYmd(e.date).substring(0, 10) === day);
        }

        /*
         * UI
         */
        function getAmountInput() {
            return document.getElementById('amount');
        }

        function getDayExpensesDiv() {
            return document.getElementById('day-expenses');
        }

        function getDescriptionInput() {
            return document.getElementById('description');
        }

        function getLineAmountInput() {
            return document.getElementById('line-amount');
        }

        function getLineDescriptionInput() {
            return document.getElementById('line-description');
        }

        function getSaveButton() {
            return document.getElementById('save-button');
        }

        function getFileInput() {
            return document.getElementById('file-input');
        }

        function getMonthTable() {
            return document.getElementById('month-table');
        }

        function getMonthLabel() {
            return document.getElementById('month-label');
        }

        function getSubmitButton() {
            return document.getElementById('submit-button');
        }

        function renderFloat(f) {
            return f.toFixed(2);
        }

        function renderDay(d) {
            return dayFormat.format(d);
        }

        function render() {
            let monthLabel = '';
            if (state.month) {
                monthLabel = monthFormat.format(new Date(state.month));
            }
            getMonthLabel().textContent = monthLabel;
            renderMonthTable();

            let dayHeading = '';
            if (state.day) {
                dayHeading = `<h2>${dayHeadingFormat.format(new Date(state.month + '-' + state.day))}</h2>`;
            }
            let dayTable = renderDayTable();
            getDayExpensesDiv().innerHTML = dayHeading + dayTable;

            let formDisabled = !state.month || !state.day || state.edit;
            getAmountInput().disabled = formDisabled;
            getDescriptionInput().disabled = formDisabled;
            getSubmitButton().disabled = formDisabled;
            getSaveButton().disabled = state.saved;
            if (formDisabled) {
                getAmountInput().value = '';
                getDescriptionInput().value = '';
            }
        }

        function renderMonthTable() {
            let tableContent = `
                    <thead>
                        <tr>
                            <td>Datum</td>
                            <td class="align-right">Betrag</td>
                            <td></td>
                            <td>Beschreibung</td>
                        </tr>
                    </thead>`;
            tableContent += '<tbody>';
            Object.entries(getDaysOfMonth(state.month))
                .forEach(d => {
                    const [ymd, row] = d;
                    tableContent += `
                    <tr>
                        <td><a href="#" onclick="setDay('${ymd.substring(8, 10)}');">${renderDay(new Date(ymd))}</a></td>
                        <td class="align-right">${row.amount ? renderFloat(row.amount) : ''}</td>
                        <td>${row.amount ? 'CHF' : ''}</td>
                        <td>${row.description.join(', ')}</td>
                    </tr>
                `;
                });
            tableContent += '</tbody>';
            getMonthTable().innerHTML = tableContent;
        }

        function renderDayTable() {
            let dayExpenses = getExpensesOfDay(state.month + '-' + state.day);
            let table = '<table>';
            if (dayExpenses.length > 0) {
                table += `
                        <thead>
                            <tr>
                                <td>Beschreibung</td>
                                <td class="align-right">Betrag</td>
                            </tr>
                        </thead>`;
            }
            table += '<tbody>';
            for (const expense of dayExpenses) {
                let row = '';
                if (state.edit === expense.id) {
                    row = `
                        <tr>
                            <td><input id="line-description" value="${expense.description}"/></td>
                            <td><input id="line-amount" class="align-right" onchange="validateDecimalField(getLineAmountInput())" value="${expense.amount}"/></td>
                            <td>CHF</td>
                            <td><button onclick="confirmLineEdit();">✅</button></td>
                            <td><button onclick="cancelLineEdit();">❌</button></td>
                        </tr>`;
                }
                else {
                    row = `
                        <tr ${!state.edit ? '' : 'class="modal"'}>
                            <td>${expense.description}</td>
                            <td class="align-right">${renderFloat(parseFloat(expense.amount))}</td>
                            <td>CHF</td>
                            ${!state.edit ? `
                                <td><button type="button" title="Bearbeiten" class="visible-on-tr-hover" onclick="startLineEdit('${expense.id}')">🖊</button></td>
                                <td><button type="button" title="Löschen" class="visible-on-tr-hover" onclick="removeExpense('${expense.id}');">🚮</button></td>` : ''}
                        </tr>`
                }
                table += row;
            }
            if (!state.edit) {
                table += `
                <tr class="va-bottom">
                    <td>
                        <label for="description">Beschreibung</label><br/>
                        <input id="description">
                    </td>
                    <td class="align-right">
                        <label for="amount">Betrag</label><br/>
                        <input id="amount" class="align-right" onchange="validateDecimalField(getAmountInput())">
                    </td>
                    <td>
                        CHF
                    </td>
                    <td>
                        <button type="button" id="submit-button" title="Hinzufügen" onclick="submitExpense();">➕</button>
                    </td>
                </tr>`;
            }
            table += `
                    </tbody>
                </table>`;
            return table;
        }

        function validateDecimalField(decimalField) {
            if (decimalField.dataset.validatedValue === decimalField.value) {
                return;
            }
            decimalField.classList.remove('error');
            if (!decimalField.value) {
                decimalField.dataset.validatedValue = decimalField.value;
                return;
            }
            if (!decimalRegex.test(decimalField.value)) {
                decimalField.dataset.validatedValue = decimalField.value;
                throw new ExpensesError(`'${decimalField.value}' ist keine gültige Zahl`, [decimalField]);
            }
            const components = decimalField.value.split('.');
            const integerPart = components[0] ? parseInt(components[0]) : '0';
            const fractionalPart = components[1] ? components[1].substring(0, 2).padEnd(2, '0') : '00';
            decimalField.value = integerPart + '.' + fractionalPart;
            decimalField.dataset.validatedValue = decimalField.value;
        }

        function validateExpense(amount, description) {
            validateDecimalField(amount);
            let emptyFields = [];
            amount.classList.remove('error');
            description.classList.remove('error');
            if (!description.value) {
                description.classList.add('error');
                emptyFields.push(description);
            }
            if (!amount.value) {
                amount.classList.add('error');
                emptyFields.push(amount);
            }
            if (emptyFields.length > 0) {
                let fieldNames = emptyFields
                    .map(f => document.querySelector(`label[for="${f.id}"]`).textContent)
                    .join(' und ');
                throw new ExpensesError(`Bitte ${fieldNames} ausfüllen`, emptyFields);
            }
            return [amount.value, description.value];
        }

        function removeExpense(id) {
            const index = getExpenses().findIndex(e => e.id === id);
            getExpenses().splice(index, 1);
            setSaved(false);
            render();
        }

        function startLineEdit(id) {
            state.edit = id;
            render();
        }

        function cancelLineEdit() {
            state.edit = null;
            render();
        }

        function confirmLineEdit() {
            const index = getExpenses().findIndex(e => e.id === state.edit);
            const entry = state.data.expenses[index];

            const [amount, description] = validateExpense(getLineAmountInput(), getLineDescriptionInput());

            entry.amount = amount;
            entry.description = description;
            state.edit = null;
            setSaved(false);
            render();
        }

        function submitExpense() {
            var date = new Date(state.month + '-' + state.day);
            let [amount, description] = validateExpense(getAmountInput(), getDescriptionInput());

            getExpenses().push({
                id: uuidv4(),
                date: date,
                amount: amount,
                description: description
            });
            setSaved(false);
            render();
        }

        function setDay(day) {
            if (state.day === day) {
                return;
            }
            state.day = day;
            render();
        }

        function openFile() {
            getFileInput().click();
        }

        function save() {
            let jsonString = JSON.stringify(state.data, null, 2);
            let dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonString);
            let a = document.createElement('a');
            a.rel = 'noopener';
            a.download = 'ausgaben.json';
            a.target = '_blank';
            a.href = dataStr;
            a.dispatchEvent(new MouseEvent('click'));
            setSaved(true);
            render();
        }

        function setSaved(value) {
            if (getExpenses().length === 0) {
                state.saved = true;
                return;
            }
            state.saved = value;
        }

        function loadExpenses() {
            var file = getFileInput().files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                let migratedData = migrate(JSON.parse(e.target.result));
                setExpenses(migratedData.expenses
                    .map(e => {
                        return {
                            id: e.id,
                            date: new Date(e.date),
                            amount: e.amount,
                            description: e.description
                        };
                    }));
                render();
            }
            reader.readAsText(file);
        }

        function migrate(loadedData) {
            // FIXME Migration für prettyfyte Zahlen
            setSaved(true);
            return loadedData;
        }
    </script>
</head>

<body>
    <h1>Ausgaben</h1>
    <span id="month-label"></span>
    <span class="float-right">
        <button type="button" title="Öffnen" onclick="openFile();">📂</button>
        <input type="file" id="file-input" class="display-none" onchange="loadExpenses()" />
        <button type="button" id="save-button" title="Speichern" onclick="save();">💾</button>
    </span>
    <hr>
    <table id="month-table"></table>
    <div id="day-expenses"></div>
    </table>

    <script>
        "use strict";
        state.month = today.substring(0, 7);
        state.day = today.substring(8, 10);
        render();
    </script>
</body>

</html>
