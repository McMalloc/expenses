<!doctype html>
<html>

<head>
    <title>Ausgaben</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html {
            font-family: sans-serif;
        }

        thead {
            font-weight: bold;
        }

        h1 {
            display: inline;
        }

        label {
            font-size: 70%;
        }

        .align-right {
            text-align: right;
        }

        .container {
            display: flex;
            flex-direction: row;
        }

        .float-right {
            float: right;
        }

        .modal {
            color: gray;
        }

        .display-none {
            display: none;
        }

        .error {
            border-color: red;
        }

        .va-bottom {
            vertical-align: bottom;
        }

        tr>td .visible-on-tr-hover {
            visibility: hidden;
        }

        tr.modal:hover>td .visible-on-tr-hover {
            visibility: hidden;
        }

        tr:hover>td .visible-on-tr-hover {
            visibility: visible;
        }

        table.indent-childs tr:not(.heading)>td:first-child {
            padding-left: 1em;
        }

        tr.heading {
            font-weight: bold;
        }

        tr.heading:not(:first-child) td {
            padding-top: 0.5em;
        }
    </style>
    <script src="lib/uuidv4.min.js"></script>
    <script>
        "use strict";

        const state = {
            saved: true,
            edit: null,
            month: null,
            day: null,
            filename: null,
            data: {
                version: 2,
                expenses: []
            }
        }

        const dayHeadingFormat = new Intl.DateTimeFormat([], { weekday: 'long', day: '2-digit', month: '2-digit' });
        const dayFormat = new Intl.DateTimeFormat([], { day: '2-digit', month: '2-digit' });
        const monthFormat = new Intl.DateTimeFormat([], { month: 'long', year: 'numeric' });
        const numberFormat = new Intl.NumberFormat(['de-CH'], { useGrouping: true, minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const decimalRegex = /^([0-9]+\.?[0-9]*|\.[0-9]+)$/;
        const integerRegex = /^([0-9]+)$/;
        const defaultExchangeRate = '1.00000';

        const today = dateToYmd(new Date(Date.now()));

        class ExpensesError {
            constructor(message, origins) {
                this.message = message;
                this.origins = origins;
            }
        }

        class Expense {
            constructor() {
                this.setId(uuidv4());
                this.setCreateDate(new Date(Date.now()));
            }

            getId() {
                return this._id;
            }

            setId(id) {
                this._id = id;
            }

            getType() {
                return this._type;
            }

            setType(type) {
                this._type = type;
            }

            getDate() {
                return this._date;
            }

            setDate(date) {
                if (typeof date === 'string') {
                    this._date = new Date(date);
                    return;
                }
                this._date = date;
            }

            getAmount() {
                return this._amount;
            }

            setAmount(amount) {
                if (typeof amount !== 'string') {
                    throw 'Amount must be a string';
                }
                this._amount = amount;
            }

            getCurrency() {
                return this._currency;
            }

            setCurrency(currency) {
                this._currency = currency;
            }

            getExchangeRate() {
                return this._exchangeRate;
            }

            setExchangeRate(exchangeRate) {
                if (typeof exchangeRate !== 'string') {
                    throw 'Exchange rate must be a string';
                }
                this._exchangeRate = exchangeRate;
            }

            getDescription() {
                return this._description;
            }

            setDescription(description) {
                this._description = description.trim();
            }

            getCreateDate() {
                return this._createDate;
            }

            setCreateDate(createDate) {
                if (typeof createDate === 'string') {
                    this._createDate = new Date(createDate);
                    return;
                }
                this._createDate = createDate;
            }

            isRecurring() {
                return this._recurring;
            }

            setRecurring(recurring) {
                if (recurring) {
                    this.setDate(null);
                }
                else {
                    this.setRecurrencePeriodicity(null);
                    this.setRecurrenceFrequency(null);
                    this.setRecurrenceFrom(null);
                    this.setRecurrenceTo(null);
                }
                this._recurring = recurring;
            }

            getRecurrencePeriodicity() {
                return this._recurrencePeriodicity;
            }

            setRecurrencePeriodicity(recurrencePeriodicity) {
                this._recurrencePeriodicity = recurrencePeriodicity;
            }

            getRecurrenceFrequency() {
                return this._recurrenceFrequency;
            }

            setRecurrenceFrequency(recurrenceFrequency) {
                if (typeof recurrenceFrequency === 'string') {
                    this._recurrenceFrequency = parseInt(recurrenceFrequency);
                    return;
                }
                this._recurrenceFrequency = recurrenceFrequency;
            }

            getRecurrenceFrom() {
                return this._recurrenceFrom;
            }

            setRecurrenceFrom(recurrenceFrom) {
                if (typeof recurrenceFrom === 'string') {
                    this._recurrenceFrom = new Date(recurrenceFrom);
                    return;
                }
                this._recurrenceFrom = recurrenceFrom;
            }

            getRecurrenceTo() {
                return this._recurrenceTo;
            }

            setRecurrenceTo(recurrenceTo) {
                if (typeof recurrenceTo === 'string') {
                    this._recurrenceTo = new Date(recurrenceTo);
                    return;
                }
                this._recurrenceTo = recurrenceTo;
            }

            computeAmountChf() {
                if (isDefaultCurrency(this.getCurrency())) {
                    return parseFloat(this.getAmount());
                }
                return parseFloat(this.getExchangeRate()) * parseFloat(this.getAmount());
            }

            computeMonthlyAmountChf() {
                return parseFloat(this.getExchangeRate()) * this.computeMonthlyAmount();
            }

            computeMonthlyAmount() {
                if (this.isRecurring()) {
                    let amountByFrequency = parseFloat(this.getAmount()) / this.getRecurrenceFrequency();
                    if (this.getRecurrencePeriodicity() === 'monthly') {
                        return amountByFrequency;
                    }
                    if (this.getRecurrencePeriodicity() === 'yearly') {
                        return amountByFrequency / 12;
                    }
                }
                return parseFloat(this.getAmount());
            }

            isValid(date) {
                if (this.isRecurring()) {
                    const firstDayOfNextMonth = getFirstDayOfNextMonth(date);
                    const firstDayOfCurrentMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                    return this.getRecurrenceFrom() < firstDayOfNextMonth && (!this.getRecurrenceTo() || this.getRecurrenceTo() >= firstDayOfCurrentMonth)
                }
                return isSameDay(date, this.getDate());
            }
        }

        window.onerror = (msg, url, lineNo, columnNo, error) => {
            if (error instanceof ExpensesError) {
                error.origins.forEach(o => o.classList.add('error'))
                alert(error.message);
                return;
            }
            throw error;
        };

        window.addEventListener('beforeunload', e => {
            if (!state.saved) {
                e.preventDefault();
                e.returnValue = 'Ungespeicherte Änderungen vorhanden';
            }
        });

        document.onkeydown = e => {
            if (e.key === 'Enter') {
                if (['description', 'amount', 'currency-input', 'date-input', 'exchange-rate', 'recurring-checkbox', 'recurring-frequency', 'recurring-monthly', 'recurring-yearly', 'recurring-from', 'recurring-to', 'type-select'].includes(e.target.id)) {
                    if (e.ctrlKey) {
                        submitForm();
                    }
                    // disable Enter-only for submitting
                    return false;
                }
            }
            if (e.ctrlKey) {
                if (e.key === 'o') {
                    openFile();
                    return false;
                }
                if (e.key === 's') {
                    save();
                    return false;
                }
            }
            return true;
        };

        /*
         * DateUtility
         */
        function getMonth(ymd) {
            return ymd.substring(0, 7);
        }

        function dateToYmd(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, 0)}`;
        }

        function isSameDay(d1, d2) {
            return d1.getDate() === d2.getDate()
                && d1.getMonth() === d2.getMonth()
                && d1.getFullYear() === d2.getFullYear();
        }

        function getFirstDayOfNextMonth(date) {
            if (date.getMonth() == 11) {
                return new Date(date.getFullYear() + 1, 0, 1);
            }
            return new Date(date.getFullYear(), date.getMonth() + 1, 1);
        }

        /*
         * Data store
         */
        function getExpenses() {
            return state.data.expenses;
        }

        function setExpenses(newExpenses) {
            state.data.expenses = newExpenses;
        }

        function getCurrentDayString() {
            return state.month + '-' + state.day;
        }

        function getOnetimeExpenses() {
            return getExpenses()
                .filter(e => !e.isRecurring());
        }

        function getDaysOfMonth(month) {
            let days = {};
            let monthNumeric = parseInt(month.substring(5, 7)) - 1;
            let date = new Date(month);
            let dateOfToday = new Date(Date.now());
            while (date.getMonth() === monthNumeric) {
                let day = {
                    description: []
                };
                getOnetimeExpenses()
                    .filter(e => isSameDay(date, e.getDate()))
                    .forEach(e => {
                        day.amount = (day.amount || 0) + e.computeAmountChf();
                        const firstHashPosition = e.getDescription().indexOf('#');
                        const dealer = e.getDescription().substr(0, firstHashPosition === -1 ? undefined : firstHashPosition).trim();
                        if (!day.description.includes(dealer)) {
                            day.description.push(dealer);
                        }
                    });
                days[dateToYmd(date)] = day;
                date.setDate(date.getDate() + 1);
            }
            return days;
        }

        /*
         * UI
         */
        function getAmountInput() {
            return document.getElementById('amount');
        }

        function getComputedChfValue() {
            return document.getElementById('computed-chf-value');
        }

        function getCurrencySelect() {
            return document.getElementById('currency-input');
        }

        function getDateInput() {
            return document.getElementById('date-input');
        }

        function getDateLabel() {
            return document.querySelector('label[for="date-input"]');
        }

        function getDayExpensesDiv() {
            return document.getElementById('day-expenses');
        }

        function getDescriptionInput() {
            return document.getElementById('description');
        }

        function getExchangeRateInput() {
            return document.getElementById('exchange-rate');
        }

        function getExpenseForm() {
            return document.getElementById('expense-form');
        }

        function getSaveButton() {
            return document.getElementById('save-button');
        }

        function getFileInput() {
            return document.getElementById('file-input');
        }

        function getMonthTable() {
            return document.getElementById('month-table');
        }

        function getMonthLabel() {
            return document.getElementById('month-label');
        }

        function getRecurringCheckbox() {
            return document.getElementById('recurring-checkbox');
        }

        function getRecurringExpenses() {
            return document.getElementById('recurring-expenses');
        }

        function getRecurringFrequency() {
            return document.getElementById('recurring-frequency');
        }

        function getRecurringFrom() {
            return document.getElementById('recurring-from');
        }

        function getRecurringMonthly() {
            return document.getElementById('recurring-monthly');
        }

        function getRecurringTo() {
            return document.getElementById('recurring-to');
        }

        function getRecurringYearly() {
            return document.getElementById('recurring-yearly');
        }

        function getTypeSelect() {
            return document.getElementById('type-select');
        }

        function renderFloat(f) {
            return numberFormat.format(f);
        }

        function renderDay(d) {
            return dayFormat.format(d);
        }

        function getEditExpense() {
            if (!state.edit) {
                return null;
            }
            const index = getExpenses().findIndex(e => e.getId() === state.edit);
            return state.data.expenses[index];
        }

        function renderAmountTd(content) {
            return `<td class="align-right">${content}</td>`;
        }

        function render() {
            let monthLabel = '';
            if (state.month) {
                monthLabel = monthFormat.format(new Date(state.month));
            }
            getMonthLabel().textContent = monthLabel;

            renderMonthOverview();
            renderMonthTable();

            const dayTable = `
                <table>
                    ${renderSection(dayHeadingFormat.format(new Date(getCurrentDayString())), e => e.getType() === 'expense' && !e.isRecurring())}
                </table>`;
            const form = renderForm();
            getDayExpensesDiv().innerHTML = dayTable + form;

            getSaveButton().disabled = state.saved;
            getDescriptionInput().focus();
            getExpenseForm().addEventListener('submit', submitForm);
        }

        function renderSection(heading, filter) {
            const currentDay = new Date(getCurrentDayString());
            const expenses = getExpenses()
                .filter(filter)
                .filter(e => e.isValid(currentDay))
                .sort((e1, e2) => e2.computeMonthlyAmountChf() - e1.computeMonthlyAmountChf());

            const sum = expenses
                .reduce((sum, e) => sum + e.computeMonthlyAmountChf(), 0.0);

            const renderSum = sum > 0.005;

            let section = `
                        <tr class="heading">
                            <td>${heading}</td>
                            ${renderAmountTd(renderSum ? renderFloat(sum) : '')}
                            <td>${renderSum ? 'CHF' : ''}</td>
                        </tr>`;

            section += expenses
                .map(e => renderExpenseTr(`
                        <td>${e.getDescription()}</td>
                        ${renderAmountTd(renderFloat(e.computeMonthlyAmount()))}
                        <td>${e.getCurrency()}</td>
                        ${renderModificationButtons(e)}`))
                .join('\n');

            return section;
        }

        function renderMonthOverview() {
            let monthOverviewHtml = `
                    <table class="indent-childs">
                        ${renderSection('Einnahmen', e => e.getType() === 'income')}
                        ${renderSection('Wiederkehrende Ausgaben', e => e.getType() === 'expense' && e.isRecurring())}
                    </table>`;

            getRecurringExpenses().innerHTML = monthOverviewHtml;
        }

        function renderMonthTable() {
            let tableContent = '';
            Object.entries(getDaysOfMonth(state.month))
                .forEach(d => {
                    const [ymd, row] = d;
                    tableContent += `
                        <tr>
                            <td><a href="#" onclick="setDay('${ymd.substring(8, 10)}');">${renderDay(new Date(ymd))}</a></td>
                            ${renderAmountTd(row.amount ? renderFloat(row.amount) : '')}
                            <td>${row.amount ? 'CHF' : ''}</td>
                            <td>${row.description.join(', ')}</td>
                        </tr>
            `;
                });
            getMonthTable().innerHTML = tableContent;
        }

        function renderFormHeader() {
            if (!state.edit) {
                return `
                    <select id="type-select">
                        <option value="expense" selected>Ausgabe</option>
                        <option value="income">Einnahme</option>
                    </select>`;
            }
            const expense = getEditExpense();
            if (expense.getType() === 'expense') {
                return 'Ausgabe';
            }
            if (expense.getType() === 'income') {
                return 'Einnahme';
            }
            throw 'Expense has unknown type';
        }

        function renderForm() {
            const expense = getEditExpense();
            const currencies = ['CHF', '€'];
            const defaultCurrency = expense ? isDefaultCurrency(expense.getCurrency()) : true;
            let form = `
                <form id="expense-form" autocomplete="off">
                    <h2>${renderFormHeader()}</h2>
                    <label for="description">Beschreibung</label>
                    <input id="description" value="${expense ? expense.getDescription() : ''}" />
                    <br />
                    <label for="amount">Betrag</label>
                    <input id="amount" class="align-right" oninput="handleAmountOrExchangeRateInput();" onchange="validateDecimalField(getAmountInput(), 2);" value="${expense ? expense.getAmount() : ''}" required />
                    <label for="currency-input" class="display-none">Währung</label>
                    <select id="currency-input" onchange="handleCurrencyChanged()" required>
                        ${currencies.map(c => `<option value="${c}" ${c === expense?.getCurrency() ? 'selected' : ''}>${c}</option>`)}
                    </select>
                    <div id="form-line2" ${defaultCurrency ? 'class="display-none"' : ''}>
                        <label for="exchange-rate">Wechselkurs</label>
                        <input class="align-right" id="exchange-rate" oninput="handleAmountOrExchangeRateInput();" onchange="validateDecimalField(getExchangeRateInput(), 5);" value="${expense ? expense.getExchangeRate() : defaultExchangeRate}" />
                        <span id="computed-chf-value">${defaultCurrency ? '' : renderFloat(expense?.computeAmountChf())}</span> CHF
                    </div>
                    <div>
                        <label for="date-input" ${expense?.isRecurring() ? 'class="display-none"' : ''}>Datum</label>
                        <input id="date-input" type="date" ${expense?.isRecurring() ? 'class="display-none"' : ''} value="${expense?.getDate() ? dateToYmd(expense.getDate()) : (expense ? '' : getCurrentDayString())}" />
                    </div>
                    <div>
                        <input id="recurring-checkbox" type="checkbox" onchange="handleRecurringCheckboxChanged();" ${expense?.isRecurring() ? 'checked' : ''} /><label for="recurring-checkbox">Wiederkehrend</label>
                        <br />
                        <input id="recurring-frequency" type="number" class="align-right" size="2" maxlength="2" value="${expense?.isRecurring() ? expense.getRecurrenceFrequency() : '1'}" onchange="validateIntegerField(getRecurringFrequency());" ${expense?.isRecurring() ? '' : 'disabled'} />-
                        <input id="recurring-monthly" name="recurring-periodicity" type="radio" ${!expense?.isRecurring() || expense.getRecurrencePeriodicity() === 'monthly' ? 'checked' : ''} ${expense?.isRecurring() ? '' : 'disabled'} /><label for="recurring-monthly">Monatlich</label>
                        <input id="recurring-yearly" name="recurring-periodicity" type="radio" ${expense?.getRecurrencePeriodicity() === 'yearly' ? 'checked' : ''} ${expense?.isRecurring() ? '' : 'disabled'} /><label for="recurring-yearly">Jährlich</label>
                    </div>
                    <div id="recurring-fromto">
                        <label for="recurring-from">Start</label><label>/</label><label for="recurring-to">Ende</label>
                        <input id="recurring-from" type="date" value="${expense?.isRecurring() ? dateToYmd(expense.getRecurrenceFrom()) : ''}" ${expense?.isRecurring() ? '' : 'disabled'} />
                        <input id="recurring-to" type="date" value="${expense?.getRecurrenceTo() ? dateToYmd(expense.getRecurrenceTo()) : ''}" ${expense?.isRecurring() ? '' : 'disabled'} />
                    </div>
                    <div class="align-right">
                    <button type ="submit" title="${expense ? 'Speichern' : 'Hinzufügen'}">${expense ? '✅' : '➕'}</button>
                    ${expense ? `<button type="button" title="Abbrechen" onclick="cancelLineEdit();">❌</button>` : ''}
                </form>`;

            return form;
        }

        function getLastExchangeRate(currency, date) {
            // TODO Wechselkurse für wiederkehrende Ausgaben
            const expensesOfDay = getExpenses()
                .filter(e => e.getCurrency() && (!e.getDate() || isSameDay(e.getDate(), date)));
            let relevantExpenses = expensesOfDay;

            if (expensesOfDay.length === 0) {
                const expensesOfCurrency = getExpenses()
                    .filter(e => e.getCurrency() === getCurrencySelect().value);

                if (expensesOfCurrency.length === 0) {
                    return null;
                }
                relevantExpenses = expensesOfCurrency;
            }

            return relevantExpenses
                .reduce((latest, e) => e.getCreateDate() > latest.getCreateDate() ? e : latest)
                .getExchangeRate();
        }

        function handleCurrencyChanged() {
            if (isDefaultCurrency(getCurrencySelect().value)) {
                document.getElementById('form-line2').classList.add('display-none');
                getExchangeRateInput().value = defaultExchangeRate;
            }
            else {
                document.getElementById('form-line2').classList.remove('display-none');
                const latestExchangeRate = getLastExchangeRate(getCurrencySelect().value, new Date(getCurrentDayString()));
                if (latestExchangeRate) {
                    getExchangeRateInput().value = latestExchangeRate;
                }
            }
        }

        function handleRecurringCheckboxChanged() {
            [getRecurringFrequency(),
            getRecurringMonthly(),
            getRecurringYearly(),
            getRecurringFrom(),
            getRecurringTo()]
                .forEach(f => f.disabled = !getRecurringCheckbox().checked);

            if (getRecurringCheckbox().checked) {
                [getDateLabel(), getDateInput()]
                    .forEach(f => f.classList.add('display-none'));

                getRecurringFrom().value = getDateInput().value;
                getDateInput().value = null;
            }
            else {
                [getDateLabel(), getDateInput()]
                    .forEach(f => f.classList.remove('display-none'));

                getDateInput().value = getRecurringFrom().value;
                getRecurringFrom().value = null;
            }
        }

        function handleAmountOrExchangeRateInput() {
            if (isDefaultCurrency(getCurrencySelect().value)) {
                return;
            }
            const chfValue = parseFloat(getAmountInput().value) * parseFloat(getExchangeRateInput().value);
            getComputedChfValue().textContent = Number.isNaN(chfValue) ? '' : renderFloat(chfValue);
        }

        function isDefaultCurrency(currency) {
            return currency === 'CHF';
        }

        function renderModificationButtons(expense) {
            return `
                    <td>
                        <button type="button" title="Bearbeiten" class="visible-on-tr-hover" onclick="startLineEdit('${expense.getId()}')">🖊</button>
                    </td>
                    <td>
                        <button type="button" title="Löschen" class="visible-on-tr-hover" onclick="removeExpense('${expense.getId()}');">🚮</button>
                    </td>`;
        }

        function renderExpenseTr(content) {
            return `<tr ${!state.edit ? '' : 'class="modal"'}>${content}</tr> `;
        }

        function validateDecimalField(decimalField, fractionalDigits) {
            validateField(decimalField, decimalRegex, () => {
                const components = decimalField.value.split('.');
                const integerPart = components[0] ? parseInt(components[0]) : '0';
                const fractionalPart = components[1] ? components[1].substring(0, fractionalDigits).padEnd(fractionalDigits, '0') : '00';
                return integerPart + '.' + fractionalPart;
            });
        }

        function validateIntegerField(integerField) {
            validateField(integerField, integerRegex, () => parseInt(integerField.value));
        }

        function validateField(field, regex, prettyPrinter) {
            field.value = field.value.trim();
            if (field.dataset.validatedValue === field.value) {
                return;
            }
            field.classList.remove('error');
            if (!field.value) {
                field.dataset.validatedValue = field.value;
                return;
            }
            if (!regex.test(field.value)) {
                field.dataset.validatedValue = field.value;
                throw new ExpensesError(`'${field.value}' ist keine gültige Zahl`, [field]);
            }
            const validatedValue = prettyPrinter();
            field.value = validatedValue;
            field.dataset.validatedValue = validatedValue;
        }

        function validateForm() {
            validateDecimalField(getAmountInput(), 2);
            validateDecimalField(getExchangeRateInput(), 5);
            validateIntegerField(getRecurringFrequency());

            const emptyFields = [];
            const mandatoryFields = [getAmountInput(), getExchangeRateInput(), getDescriptionInput()];
            if (getRecurringCheckbox().checked) {
                mandatoryFields.push(
                    getRecurringFrequency(),
                    getRecurringFrom());
            }
            else {
                mandatoryFields.push(getDateInput());
            }
            mandatoryFields.forEach(f => {
                f.classList.remove('error');
                if (!f.value) {
                    f.classList.add('error');
                    emptyFields.push(f);
                }
            });

            if (emptyFields.length > 0) {
                let fieldNames = emptyFields
                    .map(f => document.querySelector(`label[for="${f.id}"]`).textContent)
                    .join(' und ');
                throw new ExpensesError(`Bitte ${fieldNames} ausfüllen`, emptyFields);
            }
        }

        function removeExpense(id) {
            const index = getExpenses().findIndex(e => e.getId() === id);
            getExpenses().splice(index, 1);
            setSaved(false);
            render();
        }

        function startLineEdit(id) {
            state.edit = id;
            render();
        }

        function cancelLineEdit() {
            state.edit = null;
            render();
        }

        function getRecurrencePeriodicity() {
            if (!getRecurringCheckbox().checked) {
                return null;
            }
            if (getRecurringMonthly().checked) {
                return 'monthly';
            }
            if (getRecurringYearly().checked) {
                return 'yearly';
            }
        }

        function submitForm(event) {
            event?.preventDefault();

            validateForm();

            const expense = state.edit ? getEditExpense() : new Expense();
            if (getTypeSelect()) {
                expense.setType(getTypeSelect().value);
            }
            expense.setDate(getDateInput().value);
            expense.setAmount(getAmountInput().value);
            expense.setCurrency(getCurrencySelect().value);
            expense.setExchangeRate(getExchangeRateInput().value);
            expense.setDescription(getDescriptionInput().value);
            expense.setRecurrencePeriodicity(getRecurrencePeriodicity());
            expense.setRecurrenceFrequency(getRecurringFrequency().value);
            expense.setRecurrenceFrom(getRecurringFrom().value);
            if (getRecurringTo().value) {
                expense.setRecurrenceTo(getRecurringTo().value);
            }
            expense.setRecurring(getRecurringCheckbox().checked);

            if (state.edit) {
                state.edit = null;
            }
            else {
                getExpenses().push(expense);
            }

            setSaved(false);
            render();
        }

        function setDay(day) {
            if (state.day === day) {
                return;
            }
            state.day = day;
            render();
        }

        function openFile() {
            if (!state.saved && !confirm('Beim Öffnen werden ungespeicherte Änderungen überschrieben. Bist du sicher dass du eine Datei öffnen möchtest?')) {
                return;
            }
            getFileInput().click();
        }

        function save() {
            let jsonString = JSON.stringify(state.data, null, 2);
            let dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonString);
            let a = document.createElement('a');
            a.rel = 'noopener';
            a.download = state.filename || 'ausgaben.json';
            a.target = '_blank';
            a.href = dataStr;
            a.dispatchEvent(new MouseEvent('click'));
            setSaved(true);
            render();
        }

        function setSaved(value) {
            if (getExpenses().length === 0) {
                state.saved = true;
                return;
            }
            state.saved = value;
            if (!state.saved) {
                getFileInput().value = '';
            }
        }

        function loadExpenses() {
            const file = getFileInput().files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = evt => {
                const migratedData = migrate(JSON.parse(evt.target.result));
                setExpenses(migratedData.expenses
                    .map(obj => {
                        const expense = new Expense();
                        expense.setId(obj._id);
                        expense.setType(obj._type);
                        expense.setDate(obj._date);
                        expense.setAmount(obj._amount);
                        expense.setCurrency(obj._currency);
                        expense.setExchangeRate(obj._exchangeRate);
                        expense.setDescription(obj._description);
                        expense.setCreateDate(obj._createDate);
                        expense.setRecurring(obj._recurring);
                        expense.setRecurrencePeriodicity(obj._recurrencePeriodicity);
                        expense.setRecurrenceFrequency(obj._recurrenceFrequency);
                        expense.setRecurrenceFrom(obj._recurrenceFrom);
                        expense.setRecurrenceTo(obj._recurrenceTo);
                        return expense;
                    }));
                render();
                state.filename = file.name;
            }
            reader.readAsText(file);
        }

        function migrate(loadedData) {
            if (!loadedData.expenses[0]._id) {
                loadedData.expenses = loadedData.expenses.map(obj => {
                    return {
                        _id: obj.id,
                        _type: 'expense',
                        _date: obj.date,
                        _amount: obj.amount,
                        _currency: obj.currency,
                        _exchangeRate: obj.exchangeRate,
                        _description: obj.description,
                        _createDate: obj.createDate,
                        _recurring: obj.recurrence ? true : false,
                        _recurrencePeriodicity: obj.recurrence ? obj.recurrence.periodicity : null,
                        _recurrenceFrequency: obj.recurrence ? obj.recurrence.frequency : null,
                        _recurrenceFrom: obj.recurrence ? obj.recurrence.from : null,
                        _recurrenceTo: obj.recurrence ? obj.recurrence.to : null
                    };
                });
                state.saved = false;
            }
            return loadedData;
        }
    </script>
</head>

<body>
    <div class="bar">
        <h1 id="month-label">Ausgaben</h1>
        <span class="float-right">
            <button type="button" title="Öffnen" onclick="openFile();">📂</button>
            <input type="file" id="file-input" class="display-none" onchange="loadExpenses()" />
            <button type="button" id="save-button" title="Speichern" onclick="save();">💾</button>
        </span>
        <hr>
    </div>

    <div class="container">
        <div id="recurring-expenses"></div>
        <div>
            <table id="month-table"></table>
        </div>
        <div>
            <div id="day-expenses"></div>
        </div>
    </div>



    <script>
        "use strict";
        state.month = today.substring(0, 7);
        state.day = today.substring(8, 10);
        render();
    </script>
</body>

</html>
